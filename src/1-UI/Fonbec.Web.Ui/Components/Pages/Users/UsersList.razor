@attribute [Route(NavRoutes.Users)]
@attribute [Authorize]
@inherits AuthenticationRequiredComponentBase

@using Fonbec.Web.DataAccess.Constants
@using Fonbec.Web.DataAccess.Entities.Enums
@using Fonbec.Web.Logic.Models.Users

<PageHeader Title="Usuarios" />

<MudStack StretchItems="StretchItems.Middle" Row>
    <MudTooltip Text="Alta de usuario"
                Arrow="true" Placement="Placement.Right"
                Color="Color.Primary">
        <MudFab Href="@NavRoutes.UserCreate"
                StartIcon="@Icons.Material.Filled.Add"
                Color="Color.Primary" />
    </MudTooltip>
    <MudSpacer />
    <MudSwitch @bind-Value="_isLastNameFirst" LabelPlacement="Placement.Left">
        @(_isLastNameFirst ? "Apellido, Nombre" : "Nombre Apellido")
    </MudSwitch>
</MudStack>

<LoadingIndicator Loading="Loading" />

@if (_viewModel.Any())
{
    <MudDataGrid T="UsersListViewModel"
                 Items="_viewModel"
                 Dense="true" Hover="true" Striped="true" Bordered="true"
                 ReadOnly="false"
                 CommittedItemChanges="@(async viewModel => await CommittedItemChangesAsync(viewModel))"
                 EditMode="DataGridEditMode.Form"
                 EditTrigger="DataGridEditTrigger.Manual"
                 QuickFilter="Filter"
                 Filterable="true"
                 FilterMode="DataGridFilterMode.ColumnFilterRow"
                 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
                 SortMode="SortMode.Multiple"
                 Class="mt-4">
        <ToolBarContent>
            <MudTextField T="string" @bind-Value="_searchString"
                          Placeholder="Buscar"
                          Clearable="true" Immediate="true"
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" />
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="@(vm => _isLastNameFirst ? vm.UserLastName : vm.UserFirstName)" Title="Nombre">
                <CellTemplate>
                    <MudText Typo="Typo.body1">
	                    <FullNameDisplay FirstName="@context.Item.UserFirstName"
	                                     LastName="@context.Item.UserLastName"
	                                     IsLastNameFirst="_isLastNameFirst" />

                        @if (context.Item.UserId == _userId)
                        {
                            <MudChip Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" Class="ml-3">
                                YO
                            </MudChip>
                        }
                    </MudText>
                </CellTemplate>
                <EditTemplate>
                    <MudTextField T="string" @bind-Value="@context.Item.UserFirstName" Immediate="true"
                                  Required="true" RequiredError="Este es un campo requerido"
                                  Label="Nombre" Variant="Variant.Outlined" Margin="Margin.Dense"
                                  MaxLength="MaxLength.FonbecWebUser.FirstName" />
                    <MudTextField T="string" @bind-Value="@context.Item.UserLastName" Immediate="true" Class="mt-4"
                                  Required="true" RequiredError="Este es un campo requerido"
                                  Label="Apellido" Variant="Variant.Outlined" Margin="Margin.Dense"
                                  MaxLength="MaxLength.FonbecWebUser.LastName" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="vm => vm.UserRole" Title="Rol">
                <CellTemplate>
                    <MudChip Variant="Variant.Outlined" Color="MudChipColorForRole(context.Item.UserRole)">
                        @FonbecRole.Translator[context.Item.UserRole]
                    </MudChip>
                </CellTemplate>
                <EditTemplate>
	            </EditTemplate>
                <FilterTemplate>
                    <MudIconButton OnClick="@(() => _isRolesFilterOpen = true)" Icon="@_rolesFilterIcon" Size="@Size.Small" />
                    <MudOverlay OnClick="@(() => _isRolesFilterOpen = false)" Visible="@_isRolesFilterOpen" />
                    <MudPopover Open="@_isRolesFilterOpen" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter"
                                Style="width:200px">
                        <MudStack Spacing="0">
                            <MudCheckBox T="bool" Label="Seleccionar todos" Size="@Size.Small" Value="@_areAllRolesSelected" ValueChanged="OnSelectAllRolesChanged" />
                            <MudStack Spacing="0" Style="overflow-y:auto;max-height:250px">
                                @foreach (var role in FonbecRole.AllRoles)
                                {
                                    <MudCheckBox T="bool" Label="@FonbecRole.Translator[role]" Size="@Size.Small"
                                                 Value="@(_selectedRoles.Contains(role))"
                                                 ValueChanged="@(isSelected => SelectedChanged(role, isSelected))" />
                                }
                            </MudStack>
                            <MudStack Row="true" Class="d-flex justify-space-between ma-2">
                                <MudButton OnClick="@(() => ClearFilterAsync(context))" Color="Color.Default">
                                    Limpiar
                                </MudButton>
                                <MudButton OnClick="@(() => ApplyFilterAsync(context))" Color="Color.Primary" Variant="Variant.Filled">
                                    Filtrar
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudPopover>
                </FilterTemplate>
            </PropertyColumn>
            <PropertyColumn Property="vm => vm.UserChapterName" Title="Filial">
	            <EditTemplate>
	            </EditTemplate>
                <FilterTemplate>
                    <MudIconButton OnClick="@(() => _isChapterFilterOpen = true)" Icon="@_chaptersFilterIcon" Size="@Size.Small" />
                    <MudOverlay OnClick="@(() => _isChapterFilterOpen = false)" Visible="@_isChapterFilterOpen" />
                    <MudPopover Open="@_isChapterFilterOpen" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopCenter"
                                Style="width:200px">
                        <MudStack Spacing="0">
                            <MudCheckBox T="bool" Label="Seleccionar todas" Size="@Size.Small" Value="@_areAllChaptersSelected" ValueChanged="OnSelectAllChaptersChanged" />
                            <MudStack Spacing="0" Style="overflow-y:auto;max-height:250px">
                                @foreach (var chapter in _allChapters)
                                {
                                    <MudCheckBox T="bool" Label="@chapter"
                                                 Size="@Size.Small"
                                                 Value="@(_selectedChapters.Contains(chapter))"
                                                 ValueChanged="@(isSelected => SelectedChapterChanged(chapter, isSelected))" />
                                }
                            </MudStack>
                            <MudStack Row="true" Class="d-flex justify-space-between ma-2">
                                <MudButton OnClick="@(() => ClearChaptersFilterAsync(context))" Color="Color.Default">
                                    Limpiar
                                </MudButton>
                                <MudButton OnClick="@(() => ApplyChaptersFilterAsync(context))" Color="Color.Primary" Variant="Variant.Filled">
                                    Filtrar
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudPopover>
                </FilterTemplate>
            </PropertyColumn>
            <PropertyColumn Property="vm => vm.UserNickName" Title="Apodo" Hidden="true" Required="false">
                <EditTemplate>
                    <MudTextField T="string" @bind-Value="@context.Item.UserNickName" Immediate="true"
                                  Label="Apodo" Variant="Variant.Outlined" Margin="Margin.Dense"
                                  MaxLength="MaxLength.FonbecWebUser.NickName" />
				</EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="vm => vm.UserGender" Title="Sexo" Hidden="true">
                <EditTemplate>
                    <MudSelect T="Gender" @bind-Value="context.Item.UserGender" Class="mt-4"
                               Label="Sexo" Variant="Variant.Outlined" Margin="@Margin.Dense">
                        <MudSelectItem Value="Gender.Male">Masculino</MudSelectItem>
                        <MudSelectItem Value="Gender.Female">Femenino</MudSelectItem>
                    </MudSelect>
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="vm => vm.UserEmail" Title="Correo electrónico">
	            <CellTemplate>
		            <MudLink Href="@($"mailto:{context.Item.UserEmail}")">
			            @context.Item.UserEmail
		            </MudLink>
	            </CellTemplate>
                <EditTemplate>
		            <MudTextField T="string" @bind-Value="context.Item.UserEmail" Immediate="true"
		                          Label="Correo electrónico" Variant="Variant.Outlined" Margin="Margin.Dense"
		                          MaxLength="MaxLength.FonbecWebUser.Email" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="vm => vm.UserPhoneNumber" Title="Teléfono" Required="false">
                <EditTemplate>
                    <MudTextField T="string" @bind-Value="context.Item.UserPhoneNumber" Immediate="true"
                                  Label="Teléfono" Variant="Variant.Outlined" Margin="Margin.Dense"
                                  MaxLength="MaxLength.FonbecWebUser.PhoneNumber" />
				</EditTemplate>
            </PropertyColumn>
            <TemplateColumn Title="Acciones" Filterable="false" Sortable="false">
                <CellTemplate>
                    <MudTooltip Text="Editar" Arrow="true" Placement="Placement.Bottom" Color="Color.Primary" Delay="500">
                        <MudIconButton OnClick="@context.Actions.StartEditingItemAsync"
                                       Disabled="@(!context.Item.IsUserActive)"
                                       Icon="@Icons.Material.Outlined.Edit" Size="@Size.Small" Color="Color.Primary" />
                    </MudTooltip>
                    @if (context.Item.IsUserActive)
                    {
                        <MudTooltip Text="Deshabilitar" Arrow="true" Placement="Placement.Bottom" Color="Color.Warning" Delay="500">
                            <MudIconButton OnClick="@(async _ => await DisableUserAsync(context.Item))"
                                           Icon="@Icons.Material.Outlined.Delete" Size="@Size.Small" Color="Color.Warning"
                                           Disabled="@(context.Item.UserId == _userId)" />
                        </MudTooltip>
                    }
                    else
                    {
                        <MudTooltip Text="Habilitar" Arrow="true" Placement="Placement.Bottom" Color="Color.Success" Delay="500">
                            <MudIconButton OnClick="@(async _ => await ReenableUserAsync(context.Item))"
                                           Icon="@Icons.Material.Outlined.RestoreFromTrash" Size="@Size.Small" Color="Color.Success" />
                        </MudTooltip>
                    }
                    <MudTooltip Text="Eliminar" Arrow="true" Placement="Placement.Bottom" Color="Color.Error" Delay="500">
                        <MudIconButton OnClick="@(async _ => await DeleteForeverAsync(context.Item))"
                                       Icon="@Icons.Material.Outlined.DeleteForever" Size="@Size.Small" Color="Color.Error"
                                       Disabled="@(context.Item.UserId == _userId)" />
                    </MudTooltip>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="UsersListViewModel" RowsPerPageString="Filas por página:" InfoFormat="{first_item}-{last_item} of {all_items}" />
        </PagerContent>
    </MudDataGrid>
}