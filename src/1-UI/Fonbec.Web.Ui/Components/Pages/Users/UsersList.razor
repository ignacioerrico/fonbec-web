@attribute [Route(NavRoutes.Users)]
@attribute [Authorize]
@inherits AuthenticationRequiredComponentBase

@using Fonbec.Web.DataAccess.Constants
@using Fonbec.Web.DataAccess.Entities.Enums
@using Fonbec.Web.Logic.Models.Users

<PageHeader Title="Usuarios" />

<LoadingIndicator Loading="Loading" />

@if (_allUsers.Any())
{
    <MudDataGrid T="AllUsersViewModel"
                 Items="_allUsers"
                 Dense="true" Hover="true" Striped="true" Bordered="true"
                 ReadOnly="false"
                 CommittedItemChanges="@(async viewModel => await CommittedItemChangesAsync(viewModel))"
                 EditMode="DataGridEditMode.Form"
                 EditTrigger="DataGridEditTrigger.Manual"
                 QuickFilter="Filter"
                 Filterable="true"
                 FilterMode="DataGridFilterMode.ColumnFilterMenu"
                 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
                 SortMode="SortMode.Multiple"
                 Class="mt-4">
        <ToolBarContent>
            <MudTextField T="string" @bind-Value="_searchString"
                          Placeholder="Buscar"
                          Clearable="true" Immediate="true"
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" />
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="@(x => $"{x.UserFirstName} {x.UserLastName}")" Title="Nombre">
                <EditTemplate>
                    <MudTextField T="string" @bind-Value="@context.Item.UserFirstName" Immediate="true"
                                  Required="true" RequiredError="Este es un campo requerido"
                                  Label="Nombre" Variant="Variant.Outlined" Margin="Margin.Dense"
                                  MaxLength="MaxLength.FonbecWebUser.FirstName" />
                    <MudTextField T="string" @bind-Value="@context.Item.UserLastName" Immediate="true" Class="mt-4"
                                  Required="true" RequiredError="Este es un campo requerido"
                                  Label="Apellido" Variant="Variant.Outlined" Margin="Margin.Dense"
                                  MaxLength="MaxLength.FonbecWebUser.FirstName" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.UserNickName" Title="Apodo" Hidden="true" Required="false" />
            <PropertyColumn Property="x => x.UserGender" Title="Sexo" Hidden="true">
                <EditTemplate>
                    <MudSelect T="Gender" @bind-Value="context.Item.UserGender" Class="mt-4"
                               Label="Sexo" Variant="Variant.Outlined" Margin="@Margin.Dense">
                        <MudSelectItem Value="Gender.Male">Masculino</MudSelectItem>
                        <MudSelectItem Value="Gender.Female">Femenino</MudSelectItem>
                    </MudSelect>
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.UserEmail" Title="Correo electrónico">
                <CellTemplate>
                    <MudLink Href="@($"mailto:{context.Item.UserEmail}")" Typo="Typo.body2">
                        @context.Item.UserEmail
                    </MudLink>
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.UserPhoneNumber" Title="Teléfono" Required="false" />
            <TemplateColumn Title="Acciones" Filterable="false" Sortable="false">
                <CellTemplate>
                    <MudTooltip Text="Editar" Arrow="true" Placement="Placement.Bottom" Color="Color.Primary" Delay="500">
                        <MudIconButton OnClick="@context.Actions.StartEditingItemAsync"
                                       Disabled="@(!context.Item.IsUserActive)"
                                       Icon="@Icons.Material.Outlined.Edit" Size="@Size.Small" Color="Color.Primary" />
                    </MudTooltip>
                    @if (context.Item.IsUserActive)
                    {
                        <MudTooltip Text="Deshabilitar" Arrow="true" Placement="Placement.Bottom" Color="Color.Warning" Delay="500">
                            <MudIconButton OnClick="@(() => OpenDisableDialogAsync(context.Item))"
                                           Icon="@Icons.Material.Outlined.Delete" Size="@Size.Small" Color="Color.Warning" />
                        </MudTooltip>
                    }
                    else
                    {
                        <MudTooltip Text="Habilitar" Arrow="true" Placement="Placement.Bottom" Color="Color.Success" Delay="500">
                            <MudIconButton OnClick="@context.Actions.StartEditingItemAsync"
                                           Icon="@Icons.Material.Outlined.Restore" Size="@Size.Small" Color="Color.Success" />
                        </MudTooltip>
                    }
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="AllUsersViewModel" RowsPerPageString="Filas por página:" InfoFormat="{first_item}-{last_item} of {all_items}" />
        </PagerContent>
    </MudDataGrid>
}